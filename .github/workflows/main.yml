name: Build Kivy Android APK

on:
workflow_dispatch:

permissions:
contents: write
actions: read
checks: read

env:
ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
ANDROID_HOME: /usr/local/lib/android/sdk
JAVA_HOME: /usr/lib/jvm/temurin-17-jdk-amd64
CYTHON_LANGUAGE_LEVEL: "3"
GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.java-home=$JAVA_HOME -Dorg.gradle.jvmargs=-Xmx2048m"

jobs:
build-android:
runs-on: ubuntu-latest

steps:
- name: Checkout code
uses: actions/checkout@v4

- name: Set up Java 17
uses: actions/setup-java@v4
with:
java-version: '17'
distribution: 'temurin'

- name: Set up Python
uses: actions/setup-python@v5
with:
python-version: '3.9'

- name: Install system dependencies
run: |
sudo apt-get update
sudo apt-get install -y \
git zip unzip \
python3-pip autoconf automake libtool \
pkg-config zlib1g-dev libncurses5-dev \
libncursesw5-dev cmake libffi-dev libssl-dev \
curl unzip openjdk-17-jdk libltdl-dev

- name: Install Buildozer and dependencies
run: |
python -m pip install --upgrade pip
pip install buildozer cython==0.29.33 kivy==2.2.1 plyer kivymd
pip install python-for-android

- name: Generate signing key (if not exists)
id: generate_key
run: |
if [ ! -f "craft.soul.objection.keystore" ]; then
echo "生成新的签名密钥..."
keytool -genkey -v \
-keystore 文件位置 \
-alias 别名 \
-keyalg RSA -keysize 2048 \
-validity 10000 \
-storepass android \
-keypass android \
-dname "CN=Unknown, OU=Unknown, O=Unknown, L=Unknown, ST=Unknown, C=Unknown"
echo "KEY_CREATED=true" >> $GITHUB_OUTPUT
else
echo "使用现有的签名密钥"
echo "KEY_CREATED=false" >> $GITHUB_OUTPUT
fi

- name: Build APK with Buildozer (Release)
run: |
export PATH="$HOME/.local/bin:$PATH"
echo "=== 使用 Buildozer 构建 Release APK ==="
java -version
python --version
buildozer --version

# 设置环境变量解决网络问题
export BUILDODER_ALLOW_PLATFORM_EXEC=1
export USE_COLORS=0

# 设置 p4a 签名环境变量
export P4A_RELEASE_KEYSTORE="$PWD/craft.soul.objection.keystore"
export P4A_RELEASE_KEYALIAS="craft.soul.objection"
export P4A_RELEASE_KEYSTORE_PASSWD="android"
export P4A_RELEASE_KEYALIAS_PASSWD="android"

# 清理和更新
buildozer -v android clean 2>&1 | tee clean.log
buildozer -v android update 2>&1 | tee update.log

# 构建 release 版本 - 强制构建 APK
echo "=== 构建 Release APK 版本 ==="
buildozer -v android release 2>&1 | tee buildozer.log

# 查找所有 APK 和 AAB 文件并复制到当前目录
find . -name "*.apk" -exec cp {} ./ \; 2>/dev/null || true
find . -name "*.aab" -exec cp {} ./ \; 2>/dev/null || true

- name: Check if APK/AAB was built
id: check-build
run: |
if ls *.apk 1> /dev/null 2>&1 || ls *.aab 1> /dev/null 2>&1; then
echo "BUILD_FINAL_SUCCESS=true" >> $GITHUB_OUTPUT
echo "找到构建文件:"
ls -la *.apk *.aab 2>/dev/null || true
else
echo "BUILD_FINAL_SUCCESS=false" >> $GITHUB_OUTPUT
echo "未找到构建文件"
# 检查构建目录
echo "=== 检查构建目录 ==="
find .buildozer -name "*.apk" -o -name "*.aab" -type f 2>/dev/null | head -10
fi

- name: Process and rename APK/AAB files
if: steps.check-build.outputs.BUILD_FINAL_SUCCESS == 'true'
run: |
echo "=== 处理构建文件 ==="
mkdir -p bin
# 移动所有 APK 和 AAB 文件到 bin 目录
for file in *.apk *.aab; do
if [ -f "$file" ]; then
if [ -n "${{ github.ref_type }}" ] && [ "${{ github.ref_type }}" = "tag" ]; then
VERSION="${{ github.ref_name }}"
else
VERSION="$(git rev-parse --short HEAD)"
fi
# 获取文件扩展名和基本名称
filename=$(basename "$file")
extension="${filename##*.}"
filename="${filename%.*}"

# 根据文件类型命名
if [[ "$extension" == "apk" ]]; then
NEW_NAME="振动异议器-${VERSION}-release.${extension}"
else
NEW_NAME="振动异议器-${VERSION}-release.${extension}"
fi

mv "$file" "bin/${NEW_NAME}"
echo "重命名为: ${NEW_NAME}"
fi
done

echo "=== 最终构建文件 ==="
ls -la bin/

- name: Get current date
if: steps.check-build.outputs.BUILD_FINAL_SUCCESS == 'true'
id: date
run: echo "date=$(date -u +'%Y-%m-%d')" >> $GITHUB_OUTPUT

- name: Upload APK/AAB artifact
if: steps.check-build.outputs.BUILD_FINAL_SUCCESS == 'true'
uses: actions/upload-artifact@v4
with:
name: kivy-app-build
path: bin/*
retention-days: 30

- name: Upload signing key (if newly created)
if: steps.generate_key.outputs.KEY_CREATED == 'true'
uses: actions/upload-artifact@v4
with:
name: android-keystore
path: craft.soul.objection.keystore
retention-days: 1

- name: Upload build logs
if: always()
uses: actions/upload-artifact@v4
with:
name: build-logs
path: |
buildozer.log
clean.log
update.log
retention-days: 7
buildozer.spec追加内容

[app]
package.domain = 域名
# 强制构建APK，然而并没有用
android.aab = False
# 签名配置
android.keystore = /home/runner/work/keystore文件位置
android.keystore_storepass = android
android.keystore_keypass = android
android.keystore_alias = 与yml中一致
